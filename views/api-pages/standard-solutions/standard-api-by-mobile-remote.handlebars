<div class="api-documentation">
    <h1>Standard API - Mobile Remote Control</h1>

    <!-- API Reference -->
    <div class="api-reference">
        <p>This implementation is based on the <a href="https://developer.lovense.com/docs/standard-solutions/standard-api.html" target="_blank">Official Lovense Standard API Documentation</a>.</p>
    </div>

    <!-- Combined Connection Section -->
    <div class="test-section">
        <h3>1. Connection Setup</h3>
        <div class="connection-container">
            <!-- Connection Method Buttons -->
            <div class="connection-methods">
                <button onclick="selectMethod('game')" class="btn btn-method" id="gameMethod">By Game Mode</button>
                <button onclick="selectMethod('qr')" class="btn btn-method" id="qrMethod">By QR Code Scan</button>
            </div>

            <!-- Game Mode Connection Section -->
            <div id="gameSection" class="connection-section">
                <div class="game-setup">
                    <p class="info-text">Go to Discover -> Game Mode -> Turn on the "Enable LAN" switch -> input IP and Port</p>
                    <div class="game-mode-controls">
                        <input type="text" id="localIp" placeholder="Enter Local IP" class="form-control">
                        <input type="text" id="port" placeholder="Port (e.g. 30010)" class="form-control">
                        <label class="https-checkbox">
                            <input type="checkbox" id="useHttps" checked> Use HTTPS
                        </label>
                        <button onclick="connectGameMode()" class="btn btn-primary">Connect</button>
                    </div>
                    <div id="gameModeRequest" class="data-box">Request will appear here...</div>
                    <div id="gameModeResponse" class="data-box">Response will appear here...</div>
                </div>
            </div>

            <!-- QR Code Connection Section -->
            <div id="qrSection" class="connection-section" style="display: none;">
                <div class="qr-setup">
                    <p class="info-text">Please scan the QR code generated with Lovense Remote App for further test.</p>
                    <div class="userid-controls">
                        {{!-- <label>User ID:</label> --}}
                        <input type="text" id="custom-user-id" placeholder="Enter fixed User ID if you need, auto-generate if blank" class="form-control">
                        <button onclick="getQRCode()" class="btn btn-primary">Generate QR Code</button>
                    </div>
                    <div id="qrcode" class="qr-container compact"></div>
                    
                    <!-- Add QR Code API Results -->
                    <div class="api-test-results">
                        <div class="request-box">
                            <h4>QR Code Request:</h4>
                            <div id="qrRequestUrl" class="request-url">URL: </div>
                            <div class="timestamp" id="qrRequestTime">Timestamp: -</div>
                            <div id="qrRequest" class="data-box">Request will appear here...</div>
                        </div>
                        <div class="response-box">
                            <h4>QR Code Response:</h4>
                            <div class="timestamp" id="qrResponseTime">Timestamp: -</div>
                            <div id="qrResponse" class="data-box">Response will appear here...</div>
                        </div>
                    </div>

                    <p class="info-text">Callback URL: <span id="callbackUrl">/callback/latest</span></p>
                    <div id="callbackData" class="data-box">Waiting for data...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toy Management -->
    <div class="test-section">
        <h3>2. Search Connected Toys</h3>
        <button onclick="getToys()" class="btn btn-primary">Search Toys</button>
        <button onclick="getToyNames()" class="btn btn-primary">Get Toy Names</button>
        
        <div class="api-test-results">
            <div class="request-box">
                <h4>Request:</h4>
                <div id="getToyRequestUrl" class="request-url">URL: </div>
                <div class="timestamp" id="getToyRequestTime">Timestamp: -</div>
                <div id="getToyRequest">Request will appear here...</div>
            </div>
            <div class="response-box">
                <h4>Response:</h4>
                <div class="timestamp" id="getToyResponseTime">Timestamp: -</div>
                <div id="getToyResponse">Response will appear here...</div>
            </div>
        </div>
    </div>

    <!-- Command Testing -->
    <div class="test-section">
        <h3>3. Test `Function` Commands</h3>
        <div class="function-test-container">
            <div class="button-container">
                <div class="toy-id-group">
                    <label>Toy ID (not required) :</label>
                    <input type="text" id="toyId" class="form-control" placeholder="e.g., ff922f7fd345">
                </div>
                <button onclick="testFunction()" class="btn btn-primary">Test Function</button>
                <button onclick="stopFunction()" class="btn btn-danger">Stop</button>
                <button onclick="resetAllActions()" class="btn btn-secondary">Reset All</button>
            </div>
            
            <!-- Action sliders -->
            <div class="action-sliders">
                <div class="action-group">
                    <label>All (0-20):</label>
                    <div class="strength-control">
                        <input type="range" id="all" class="strength-slider" min="0" max="20" value="0">
                        <input type="number" class="form-control strength-number" data-slider="all" min="0" max="20" value="0">
                    </div>
                </div>
                <div class="action-group">
                    <label>Vibrate (0-20):</label>
                    <div class="strength-control">
                        <input type="range" id="vibrate" class="strength-slider" min="0" max="20" value="0">
                        <input type="number" class="form-control strength-number" data-slider="vibrate" min="0" max="20" value="0">
                    </div>
                </div>
                <div class="action-group">
                    <label>Rotate (0-20):</label>
                    <div class="strength-control">
                        <input type="range" id="rotate" class="strength-slider" min="0" max="20" value="0">
                        <input type="number" class="form-control strength-number" data-slider="rotate" min="0" max="20" value="0">
                    </div>
                </div>
                <div class="action-group">
                    <label>Pump (0-3):</label>
                    <div class="strength-control">
                        <input type="range" id="pump" class="strength-slider" min="0" max="3" value="0">
                        <input type="number" class="form-control strength-number" data-slider="pump" min="0" max="3" value="0">
                    </div>
                </div>
                <div class="action-group">
                    <label>Thrusting (0-20):</label>
                    <div class="strength-control">
                        <input type="range" id="thrusting" class="strength-slider" min="0" max="20" value="0">
                        <input type="number" class="form-control strength-number" data-slider="thrusting" min="0" max="20" value="0">
                    </div>
                </div>
                <div class="action-group">
                    <label>Fingering (0-20):</label>
                    <div class="strength-control">
                        <input type="range" id="fingering" class="strength-slider" min="0" max="20" value="0">
                        <input type="number" class="form-control strength-number" data-slider="fingering" min="0" max="20" value="0">
                    </div>
                </div>
                <div class="action-group">
                    <label>Suction (0-20):</label>
                    <div class="strength-control">
                        <input type="range" id="suction" class="strength-slider" min="0" max="20" value="0">
                        <input type="number" class="form-control strength-number" data-slider="suction" min="0" max="20" value="0">
                    </div>
                </div>
                <div class="action-group">
                    <label>Depth (0-3):</label>
                    <div class="strength-control">
                        <input type="range" id="depth" class="strength-slider" min="0" max="3" value="0">
                        <input type="number" class="form-control strength-number" data-slider="depth" min="0" max="3" value="0">
                    </div>
                </div>
                <div class="action-group">
                    <label>Stroke (0-100):</label>
                    <div class="strength-control">
                        <input type="range" id="stroke" class="strength-slider" min="0" max="100" value="0">
                        <input type="number" class="form-control strength-number" data-slider="stroke" min="0" max="100" value="0">
                    </div>
                </div>
                <div class="action-group">
                    <label>Oscillate (0-20):</label>
                    <div class="strength-control">
                        <input type="range" id="oscillate" class="strength-slider" min="0" max="20" value="0">
                        <input type="number" class="form-control strength-number" data-slider="oscillate" min="0" max="20" value="0">
                    </div>
                </div>
            </div>

            <div class="time-inputs">
                <div class="input-group">
                    <label>Total:</label>
                    <input type="number" id="totalTime" class="form-control" placeholder="seconds, set 5 if blank">
                </div>
                <div class="input-group">
                    <label>Running:</label>
                    <input type="number" id="runningTime" class="form-control" placeholder="seconds, set 5 if blank">
                </div>
                <div class="input-group">
                    <label>Pause:</label>
                    <input type="number" id="pauseTime" class="form-control" placeholder="seconds, set 0 if blank">
                </div>
            </div>

            <div class="api-test-results">
                <div class="request-box">
                    <h4>Request:</h4>
                    <div id="commandRequestUrl" class="request-url">URL: </div>
                    <div class="timestamp" id="commandRequestTime">Timestamp: -</div>
                    <div id="commandRequest">Request will appear here...</div>
                </div>
                <div class="response-box">
                    <h4>Response:</h4>
                    <div class="timestamp" id="commandResponseTime">Timestamp: -</div>
                    <div id="commandResponse">Response will appear here...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pattern Testing -->
    <div class="test-section">
        <h3>4. Test `Pattern` Commands</h3>

        <!-- Header with Toy ID -->
        <div class="pattern-header">
            <div class="toy-id-group">
                <label>Toy ID (not required) :</label>
                <input type="text" id="patternToyId" class="form-control" placeholder="e.g., ff922f7fd345">
            </div>
            <div class="pattern-controls">
                <button onclick="testPattern()" class="btn btn-primary">Test Pattern</button>
                <button onclick="stopFunction()" class="btn btn-danger">Stop</button>
            </div>
        </div>

        <!-- Pattern Input Tabs -->
        <div class="pattern-tabs">
            <button class="pattern-tab active" onclick="switchPatternTab('form')">
                <i class="tab-icon">📝</i>Form
            </button>
            <button class="pattern-tab" onclick="switchPatternTab('json')">
                <i class="tab-icon">{ }</i>JSON
            </button>
        </div>

        <div class="pattern-test-container">
            <!-- Form Input Section -->
            <div id="formInputTab" class="pattern-tab-content active">
                <div class="pattern-inputs">
                    <div class="feature-group">
                        <div class="feature-header">
                            <label>Features:</label>
                            <button onclick="toggleAllFeatures()" class="btn btn-sm btn-secondary" id="toggleFeaturesBtn">Check All</button>
                        </div>
                        <div class="feature-checkboxes">
                            <label><input type="checkbox" value="v" checked> Vibrate</label>
                            <label><input type="checkbox" value="r"> Rotate</label>
                            <label><input type="checkbox" value="p"> Pump</label>
                            <label><input type="checkbox" value="t"> Thrust</label>
                            <label><input type="checkbox" value="f"> Finger</label>
                            <label><input type="checkbox" value="s"> Suction</label>
                            <label><input type="checkbox" value="d"> Depth</label>
                            <label><input type="checkbox" value="o"> Oscillate</label>
                        </div>
                    </div>

                    <div class="pattern-group">
                        <label>Pattern Strength (semicolon-separated numbers 0-20):</label>
                        <input type="text" id="patternStrength" class="form-control" 
                               placeholder="e.g., 20;20;5;20;10" value="20;20;5;20;10">
                    </div>

                    <div class="pattern-timing">
                        <div class="interval-group">
                            <label>Interval (milliseconds, min 100):</label>
                            <input type="number" id="patternInterval" class="form-control" 
                                   min="100" value="1000">
                        </div>

                        <div class="time-group">
                            <label>Total Time (seconds):</label>
                            <input type="number" id="patternTime" class="form-control" 
                                   min="1" value="9">
                        </div>
                    </div>
                </div>
            </div>

            <!-- JSON Input Section -->
            <div id="jsonInputTab" class="pattern-tab-content">
                <div class="json-input-group">
                    <div class="json-header">
                        <label>Pattern Request JSON (click to modify):</label>
                        <button onclick="formatJsonInput()" class="btn btn-sm btn-secondary">Format JSON</button>
                    </div>
                    <div class="json-editor">
                        <textarea id="patternJson" class="form-control json-textarea" rows="8" 
                            placeholder='{
    "command": "Pattern",
    "rule": "V:1;F:v,r,p,t,f,s,d,o;S:1000#",
    "strength": "20;20;5;20;10",
    "timeSec": 9,
    "apiVer": 2
}'></textarea>
                        <div class="json-hint">
                            <i class="hint-icon">ℹ️</i>
                            <span>Enter a valid JSON object with the pattern command parameters</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="api-test-results">
                <div class="request-box">
                    <h4>Request:</h4>
                    <div id="patternRequestUrl" class="request-url">URL: </div>
                    <div class="timestamp" id="patternRequestTime">Timestamp: -</div>
                    <div id="patternRequest">Request will appear here...</div>
                </div>
                <div class="response-box">
                    <h4>Response:</h4>
                    <div class="timestamp" id="patternResponseTime">Timestamp: -</div>
                    <div id="patternResponse">Response will appear here...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add this after the Pattern Testing section -->
    <div class="test-section">
        <h3>5. Test `Preset` Pattern Commands</h3>
        
        <div class="pattern-header">
            <div class="toy-id-group">
                <label>Toy ID (not required):</label>
                <input type="text" id="presetToyId" class="form-control" placeholder="e.g., ff922f7fd345">
            </div>
            <div class="pattern-controls">
                <button onclick="testPresetPattern()" class="btn btn-primary">Test Preset</button>
                <button onclick="stopFunction()" class="btn btn-danger">Stop</button>
            </div>
        </div>

        <div class="preset-inputs">
            <div class="input-group compact">
                <label>Preset Pattern:</label>
                <div class="preset-options">
                    <label class="preset-option">
                        <input type="radio" name="presetPattern" value="pulse" checked> Pulse
                    </label>
                    <label class="preset-option">
                        <input type="radio" name="presetPattern" value="wave"> Wave
                    </label>
                    <label class="preset-option">
                        <input type="radio" name="presetPattern" value="fireworks"> Fireworks
                    </label>
                    <label class="preset-option">
                        <input type="radio" name="presetPattern" value="earthquake"> Earthquake
                    </label>
                </div>
            </div>
            
            <div class="input-group compact">
                <label>Total Time (seconds):</label>
                <input type="number" id="presetTime" class="form-control" 
                       min="0" value="9" placeholder="0 = indefinite length">
            </div>
        </div>

        <div class="api-test-results">
            <div class="request-box">
                <h4>Request:</h4>
                <div id="presetRequestUrl" class="request-url">URL: </div>
                <div class="timestamp" id="presetRequestTime">Timestamp: -</div>
                <div id="presetRequest">Request will appear here...</div>
            </div>
            <div class="response-box">
                <h4>Response:</h4>
                <div class="timestamp" id="presetResponseTime">Timestamp: -</div>
                <div id="presetResponse">Response will appear here...</div>
            </div>
        </div>
    </div>
    
    <!-- Update the Solace Pro Commands section -->
    <div class="test-section">
        <h3>6. Test `Position` Commands</h3>
        <p class="test-description">Special command for Solace Pro, and only Solace Pro will respond to.</p>
        
        <div class="function-test-container">
            <div class="action-group">
                <label>Position (0-100):</label>
                <div class="strength-control">
                    <input type="range" id="position" class="strength-slider" min="0" max="100" value="0">
                    <input type="number" class="form-control strength-number" data-slider="position" min="0" max="100" value="0">
                </div>
                <button onclick="testPosition()" class="btn btn-primary" style="margin-left: 10px;">Test Position</button>
            </div>

            <div class="api-test-results">
                <div class="request-box">
                    <h4>Request:</h4>
                    <div id="positionRequestUrl" class="request-url">URL: </div>
                    <div class="timestamp" id="positionRequestTime">Timestamp: -</div>
                    <div id="positionRequest">Request will appear here...</div>
                </div>
                <div class="response-box">
                    <h4>Response:</h4>
                    <div class="timestamp" id="positionResponseTime">Timestamp: -</div>
                    <div id="positionResponse">Response will appear here...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Update the PatternV2 Commands section -->
    <div class="test-section">
        <h3>7. Test `PatternV2` Commands</h3>
        <p class="test-description">Send advanced pattern commands to Solace Pro. Each action consists of a timestamp (ms) and position value.</p>
        
        <div class="pattern-header">
            <div class="toy-id-group">
                <label>Toy ID (not required):</label>
                <input type="text" id="patternv2ToyId" class="form-control" placeholder="e.g., ff922f7fd345">
            </div>
            <div class="pattern-controls">
                <button onclick="testPatternV2()" class="btn btn-primary">Send Request</button>
                <button onclick="stopFunction()" class="btn btn-danger">Stop</button>
            </div>
        </div>

        <!-- Pattern Input Tabs -->
        <div class="pattern-v2-tabs">
            <button class="pattern-v2-tab active" onclick="switchPatternV2Tab('setup')">
                <i class="tab-icon">⚙️</i>Setup
            </button>
            <button class="pattern-v2-tab" onclick="switchPatternV2Tab('play')">
                <i class="tab-icon">▶️</i>Play
            </button>
            <button class="pattern-v2-tab" onclick="switchPatternV2Tab('sync')">
                <i class="tab-icon">🔄</i>Sync
            </button>
        </div>

        <div class="pattern-test-container">
            <!-- Setup Tab -->
            <div id="setup-tab" class="pattern-tab-content active">
                <div class="command-container">
                    <div class="input-method-toggle">
                        <label class="input-method-option">
                            <input type="radio" name="setupInputMethod" value="form" checked> Form Input
                        </label>
                        <label class="input-method-option">
                            <input type="radio" name="setupInputMethod" value="json"> JSON Input
                        </label>
                    </div>

                    <div class="form-section" id="setupFormSection">
                        <div class="section-header">
                            <h4>Form Input</h4>
                            <div class="section-controls">
                                <button onclick="copyPatternV2FormToJson()" class="btn btn-sm btn-info">Copy as JSON</button>
                                <button onclick="clearPatternActions()" class="btn btn-sm btn-secondary">Clear All</button>
                            </div>
                        </div>
                        <div class="patternv2-inputs">
                            <div class="pattern-actions" id="patternActions">
                                <div class="action-row">
                                    <div class="input-group">
                                        <label>Timestamp (ms):</label>
                                        <input type="number" class="form-control ts-input" min="0" max="7200000" value="0">
                                    </div>
                                    <div class="input-group">
                                        <label>Position (0-100):</label>
                                        <input type="number" class="form-control pos-input" min="0" max="100" value="10">
                                    </div>
                                    <div class="action-buttons">
                                        <button onclick="removePatternAction(this)" class="btn btn-icon btn-danger">×</button>
                                        <button onclick="addPatternAction()" class="btn btn-icon btn-secondary">+</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="json-section" id="setupJsonSection" style="display: none;">
                        <div class="json-header">
                            <h4>Direct JSON Input</h4>
                            <button onclick="formatPatternV2Json()" class="btn btn-sm btn-secondary">Format JSON</button>
                        </div>
                        <div class="json-input-container">
                            <textarea id="setupJsonInput" class="json-textarea compact" placeholder='[{"ts":0,"pos":10},{"ts":100,"pos":50}]'></textarea>
                            <div class="hint">Input actions array only. Other parameters will use default values.</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Play Tab -->
            <div id="play-tab" class="pattern-tab-content">
                <div class="command-container">
                    <div class="play-inputs">
                        <div class="input-group compact">
                            <label>Start Time (ms):</label>
                            <input type="number" id="playStartTime" class="form-control" value="0">
                        </div>
                        <div class="input-group compact">
                            <label>Offset Time (ms):</label>
                            <input type="number" id="playOffsetTime" class="form-control" value="0">
                        </div>
                        <div class="input-group compact">
                            <label>Total Running Time (ms):</label>
                            <input type="number" id="playTimeMS" class="form-control" value="10000">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sync Time Tab -->
            <div id="sync-tab" class="pattern-tab-content">
                <div class="command-container">
                    <div class="sync-info">
                        <p>This function helps calculate the offset time from the server:</p>
                        <ol>
                            <li>Records time T1 before sending request</li>
                            <li>Records time T2 after receiving response</li>
                            <li>Calculates offset: (T2 - T1)</li>
                        </ol>
                        <div id="syncResults" class="sync-results">
                            <div>Start Time (T1): <span id="syncT1">-</span></div>
                            <div>End Time (T2): <span id="syncT2">-</span></div>
                            <div>Calculated Offset: <span id="syncOffset">-</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- API test results -->
            <div class="api-test-results">
                <div class="request-box">
                    <h4>Request:</h4>
                    <div id="patternv2RequestUrl" class="request-url">URL: </div>
                    <div class="timestamp" id="patternv2RequestTime">Timestamp: -</div>
                    <div id="patternv2Request">Request will appear here...</div>
                </div>
                <div class="response-box">
                    <h4>Response:</h4>
                    <div class="timestamp" id="patternv2ResponseTime">Timestamp: -</div>
                    <div id="patternv2Response">Response will appear here...</div>
                </div>
            </div>
        </div>
    </div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
const API_BASE = '/api/v2';
const DEFAULT_TOKEN = "tf7_SsG7X8qJm5l4gSYzfdLSeaZtlLl8ZaWNOSLt_ScnbUpimwPUIxB5l9TAgNle";

function generateMD5(string) {
    if (typeof CryptoJS === 'undefined') {
        throw new Error('CryptoJS library is not loaded');
    }
    return CryptoJS.MD5(string).toString();
}

async function getQRCode() {
    try {
        const qrcodeDiv = document.getElementById('qrcode');
        qrcodeDiv.innerHTML = 'Generating QR Code...';
        
        const token = DEFAULT_TOKEN;  // Always use default token
        const uid = document.getElementById('custom-user-id').value || "test_" + Math.random().toString(36).substr(2, 9);
        const uname = "user_" + uid;
        const utoken = generateMD5(uid + "salt");
        
        // Prepare request data
        const requestData = {
            token: token,
            uid: uid,
            uname: uname,
            utoken: utoken,
            v: 2
        };

        // Update request display
        const requestTimestamp = getChineseTimestamp();
        document.getElementById('qrRequestUrl').innerHTML = 'URL: https://api.lovense-api.com/api/lan/getQrCode';
        document.getElementById('qrRequestTime').innerHTML = `Timestamp: ${requestTimestamp}`;
        document.getElementById('qrRequest').innerHTML = JSON.stringify(requestData, null, 2);
        
        const response = await axios.post(
            "https://api.lovense-api.com/api/lan/getQrCode",
            requestData
        );
        
        // Update response display
        const responseTimestamp = getChineseTimestamp();
        document.getElementById('qrResponseTime').innerHTML = `Timestamp: ${responseTimestamp}`;
        document.getElementById('qrResponse').innerHTML = JSON.stringify(response.data, null, 2);
        
        if (response.data && response.data.code === 0) {
            qrcodeDiv.innerHTML = '';
            const img = document.createElement('img');
            img.src = response.data.data.qr;
            img.style.maxWidth = '200px';
            img.style.height = 'auto';
            qrcodeDiv.appendChild(img);
            
            const callbackUrlText = document.getElementById('callbackUrl');
            callbackUrlText.textContent = document.createTextNode(`${API_BASE}/lovense/callback/latest`).textContent;
        } else {
            qrcodeDiv.innerHTML = 'Error: ' + (response.data.message || 'Failed to generate QR code');
        }
    } catch (error) {
        console.error('QR Code generation failed:', error);
        document.getElementById('qrcode').innerHTML = 'Error: ' + error.message;
        
        // Update response display with error
        const errorTimestamp = getChineseTimestamp();
        document.getElementById('qrResponseTime').innerHTML = `Timestamp: ${errorTimestamp}`;
        document.getElementById('qrResponse').innerHTML = `Error: ${error.message}`;
    }
}

function getChineseTimestamp() {
    const options = {
        timeZone: 'Asia/Shanghai',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
    };
    return new Date().toLocaleString('zh-CN', options);
}

async function getToys() {
    const getToyRequest = document.getElementById('getToyRequest');
    const getToyResponse = document.getElementById('getToyResponse');
    const getToyRequestTime = document.getElementById('getToyRequestTime');
    const getToyResponseTime = document.getElementById('getToyResponseTime');

    try {
        const apiUrl = getCurrentApiUrl();
        document.getElementById('getToyRequestUrl').innerHTML = `URL: ${apiUrl}`;
        
        const requestData = {
            command: "GetToys"
        };
        
        // Update request timestamp and display
        getToyRequestTime.innerHTML = `Timestamp: ${getChineseTimestamp()}`;
        getToyRequest.innerHTML = JSON.stringify(requestData, null, 2);

        const response = await axios.post(apiUrl, requestData, { 
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        // Update response timestamp and display
        getToyRequestTime.innerHTML = `Timestamp: ${getChineseTimestamp()}`;
        getToyResponse.innerHTML = JSON.stringify(response.data, null, 2);
        getToyResponse.style.color = '#28a745';
    } catch (error) {
        // Update response timestamp and error display
        getToyRequestTime.innerHTML = `Timestamp: ${getChineseTimestamp()}`;
        getToyResponse.innerHTML = `Error: ${error.message}`;
        getToyResponse.style.color = '#dc3545';
    }
}

async function getToyNames() {
    const getToyRequest = document.getElementById('getToyRequest');
    const getToyResponse = document.getElementById('getToyResponse');
    const getToyRequestTime = document.getElementById('getToyRequestTime');
    const getToyResponseTime = document.getElementById('getToyResponseTime');

    try {
        const apiUrl = getCurrentApiUrl();
        
        const requestData = {
            command: "GetToyName"
        };
        
        // Update request timestamp and display
        getToyRequestTime.innerHTML = `Timestamp: ${getChineseTimestamp()}`;
        getToyRequest.innerHTML = JSON.stringify(requestData, null, 2);
        
        const response = await axios.post(apiUrl, requestData, {
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        // Update response timestamp and display
        getToyRequestTime.innerHTML = `Timestamp: ${getChineseTimestamp()}`;
        getToyResponse.innerHTML = JSON.stringify(response.data, null, 2);
        getToyResponse.style.color = '#28a745';
    } catch (error) {
        // Update response timestamp and error display
        getToyRequestTime.innerHTML = `Timestamp: ${getChineseTimestamp()}`;
        getToyResponse.innerHTML = `Error: ${error.message}`;
        getToyResponse.style.color = '#dc3545';

        {{!-- if (error.code === 'ERR_NETWORK') {
            errorMessage += 'Network Error: Unable to connect to the toy. Please ensure:\n';
            errorMessage += '1. The toy is connected and within range\n';
            errorMessage += '2. The correct IP and port are being used\n';
            errorMessage += '3. Your browser allows mixed content if using HTTPS\n';
            errorMessage += '4. You are on the same network as the toy\n';
            errorMessage += '\nTechnical details: ' + error.message;
        } else {
            errorMessage += error.message;
        }
        console.error('Detailed error:', error); --}}
    }
}

function initCallbackListener() {
    const baseUrl = window.location.origin;
    const callbackUrl = `${baseUrl}/api/v2/lovense/callback/latest`;
    
    const callbackUrlText = document.getElementById('callbackUrl');
    if (callbackUrlText) {
        callbackUrlText.textContent = callbackUrl;
    }

    // Add initial status message
    const callbackData = document.getElementById('callbackData');
    callbackData.innerHTML = `
        <div class="timestamp">Status: Waiting for connection...</div>
        <div class="hint">After scanning QR code, connection data will appear here.</div>
    `;

    // Set up polling interval
    const pollInterval = setInterval(async () => {
        try {
            console.log('Polling for callback data...'); // Debug log
            const response = await axios.get(`${API_BASE}/lovense/callback/latest`);
            
            if (response.data) {
                console.log('Received callback data:', response.data); // Debug log
                const timestamp = getChineseTimestamp();
                const formattedData = JSON.stringify(response.data, null, 2);
                
                callbackData.innerHTML = `
                    <div class="timestamp">Last Updated: ${timestamp}</div>
                    <div class="connection-status">Status: Connected</div>
                    <pre>${formattedData}</pre>
                `;
            } else {
                console.log('No callback data received'); // Debug log
                callbackData.innerHTML = `
                    <div class="timestamp">Last Updated: ${getChineseTimestamp()}</div>
                    <div class="connection-status">Status: Waiting for connection...</div>
                    <div class="hint">Make sure QR code is properly scanned in Lovense Remote app</div>
                `;
            }
        } catch (error) {
            console.error('Callback polling error:', error); // Debug log
            const timestamp = getChineseTimestamp();
            callbackData.innerHTML = `
                <div class="timestamp">Last Updated: ${timestamp}</div>
                <div class="connection-status error">Error: ${error.message}</div>
                <div class="hint">Check server connectivity and try scanning QR code again</div>
            `;
        }
    }, 15000); // Poll every 10 seconds

    // Clean up interval on page unload
    window.addEventListener('unload', () => {
        clearInterval(pollInterval);
    });
}

function selectMethod(method) {
    // Reset button styles
    document.querySelectorAll('.btn-method').forEach(btn => {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-secondary');
    });

    // Show/hide appropriate sections
    if (method === 'game') {
        document.getElementById('qrSection').style.display = 'none';
        document.getElementById('gameSection').style.display = 'block';
        document.getElementById('gameMethod').classList.add('btn-primary');
        document.getElementById('gameMethod').classList.remove('btn-secondary');
    } else {
        document.getElementById('qrSection').style.display = 'block';
        document.getElementById('gameSection').style.display = 'none';
        document.getElementById('qrMethod').classList.add('btn-primary');
        document.getElementById('qrMethod').classList.remove('btn-secondary');
    }
}

async function connectGameMode() {
    const gameModeRequest = document.getElementById('gameModeRequest');
    const gameModeResponse = document.getElementById('gameModeResponse');
    
    try {
        const apiUrl = getApiUrl();
        const requestData = {
            command: "GetToys"
        };

        // Display request details
        const requestTimestamp = getChineseTimestamp();
        const requestDisplay = `Request (${requestTimestamp})\nURL: ${apiUrl}\n\n${JSON.stringify(requestData, null, 2)}`;
        gameModeRequest.innerHTML = requestDisplay;

        const response = await axios.post(apiUrl, requestData, {
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        // Display response details
        const responseTimestamp = getChineseTimestamp();
        const responseDisplay = `Response (${responseTimestamp})\n\n${JSON.stringify(response.data, null, 2)}`;
        gameModeResponse.innerHTML = responseDisplay;
        gameModeResponse.style.color = '#28a745';
    } catch (error) {
        // Display error details
        const errorTimestamp = getChineseTimestamp();
        const errorDisplay = `Error (${errorTimestamp})\n\n${error.message}`;
        gameModeResponse.innerHTML = errorDisplay;
        gameModeResponse.style.color = '#dc3545';
    }
}

// Initialize with Game Mode selected
document.addEventListener('DOMContentLoaded', () => {
    selectMethod('game');
    initCallbackListener();
});


document.addEventListener('DOMContentLoaded', function() {
    // Get all sliders
    const sliders = document.querySelectorAll('.strength-slider');
    const numberInputs = document.querySelectorAll('.strength-number');

    // Add listeners for sliders
    sliders.forEach(slider => {
        slider.addEventListener('input', function() {
            const numberInput = this.nextElementSibling;
            numberInput.value = this.value;
        });
    });

    // Add listeners for number inputs
    numberInputs.forEach(input => {
        input.addEventListener('input', function() {
            const slider = this.previousElementSibling;
            const value = parseInt(this.value);
            const max = parseInt(this.max);
            
            if (!isNaN(value) && value >= 0 && value <= max) {
                slider.value = value;
            }
        });
    });

    // Add port input validation
    const portInput = document.getElementById('port');
    portInput.addEventListener('input', function() {
        const value = this.value;
        const httpsCheckbox = document.getElementById('useHttps');
        
        // If port is 20010, force HTTP
        if (value === '20010') {
            httpsCheckbox.checked = false;
        }
        // If port is 30010, force HTTPS
        else if (value === '30010') {
            httpsCheckbox.checked = true;
        }
    });
});

async function testFunction() {
    const commandRequest = document.getElementById('commandRequest');
    const commandResponse = document.getElementById('commandResponse');
    const commandRequestTime = document.getElementById('commandRequestTime');
    const commandResponseTime = document.getElementById('commandResponseTime');
    const toyId = document.getElementById('toyId').value;
    const totalTime = document.getElementById('totalTime').value || 5;  // Default to 5 if blank
    const runningTime = document.getElementById('runningTime').value || 5;  // Default to 5 if blank
    const pauseTime = document.getElementById('pauseTime').value || 0;  // Default to 0 if blank
    
    try {
        const apiUrl = getCurrentApiUrl();
        document.getElementById('commandRequestUrl').innerHTML = `URL: ${apiUrl}`;

        // Collect all non-zero actions
        const actions = [];
        const actionTypes = ['vibrate', 'rotate', 'pump', 'thrusting', 'fingering', 'suction', 'depth', 'stroke', 'all', 'oscillate'];
        
        actionTypes.forEach(type => {
            const value = document.getElementById(type).value;
            if (value > 0) {
                // Special handling for Oscillate command
                const actionName = type === 'oscillate' ? 'Oscillate' : type.charAt(0).toUpperCase() + type.slice(1);
                actions.push(`${actionName}:${value}`);
            }
        });

        if (actions.length === 0) {
            throw new Error('Please set at least one action value above 0');
        }

        const requestData = {
            command: "Function",
            action: actions.join(','),
            timeSec: parseInt(totalTime),
            loopRunningSec: parseInt(runningTime),
            loopPauseSec: parseInt(pauseTime),
            toy: toyId,
            apiVer: 1
        };
        
        // Update request timestamp and display
        commandRequestTime.innerHTML = `Timestamp: ${getChineseTimestamp()}`;
        commandRequest.innerHTML = JSON.stringify(requestData, null, 2);

        const response = await axios.post(apiUrl, requestData, {
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        // Update response timestamp and display
        commandResponseTime.innerHTML = `Timestamp: ${getChineseTimestamp()}`;
        commandResponse.innerHTML = JSON.stringify(response.data, null, 2);
        commandResponse.style.color = '#28a745';
    } catch (error) {
        // Update response timestamp and error display
        commandResponseTime.innerHTML = `Timestamp: ${getChineseTimestamp()}`;
        commandResponse.innerHTML = `Error: ${error.message}`;
        commandResponse.style.color = '#dc3545';
    }
}

async function testPosition() {
    const positionRequest = document.getElementById('positionRequest');
    const positionResponse = document.getElementById('positionResponse');
    const positionRequestTime = document.getElementById('positionRequestTime');
    const positionResponseTime = document.getElementById('positionResponseTime');
    const position = document.getElementById('position').value;
    
    try {
        const apiUrl = getCurrentApiUrl();
        document.getElementById('positionRequestUrl').innerHTML = `URL: ${apiUrl}`;

        const requestData = {
            command: "Position",
            value: position,
            apiVer: 1
        };
        
        // Update request timestamp and display
        positionRequestTime.innerHTML = `Timestamp: ${getChineseTimestamp()}`;
        positionRequest.innerHTML = JSON.stringify(requestData, null, 2);

        const response = await axios.post(apiUrl, requestData, {
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        // Update response timestamp and display
        positionRequestTime.innerHTML = `Timestamp: ${getChineseTimestamp()}`;
        positionResponse.innerHTML = JSON.stringify(response.data, null, 2);
        positionResponse.style.color = '#28a745';
    } catch (error) {
        // Update response timestamp and error display
        positionRequestTime.innerHTML = `Timestamp: ${getChineseTimestamp()}`;
        positionResponse.innerHTML = `Error: ${error.message}`;
        positionResponse.style.color = '#dc3545';
    }
}

async function testPattern() {
    const patternRequest = document.getElementById('patternRequest');
    const patternResponse = document.getElementById('patternResponse');
    const patternRequestTime = document.getElementById('patternRequestTime');
    const patternResponseTime = document.getElementById('patternResponseTime');
    
    try {
        let requestData;
        // Check which tab is active instead of checking display style
        const isJsonMode = document.getElementById('jsonInputTab').classList.contains('active');
        
        if (isJsonMode) {
            // Parse JSON input
            const jsonInput = document.getElementById('patternJson').value;
            try {
                requestData = JSON.parse(jsonInput);
            } catch (e) {
                throw new Error('Invalid JSON format: ' + e.message);
            }
        } else {
            // Get form input values
            const toyId = document.getElementById('patternToyId').value;
            const selectedFeatures = Array.from(document.querySelectorAll('.feature-checkboxes input:checked'))
                .map(cb => cb.value)
                .join(',');
            const interval = document.getElementById('patternInterval').value;
            const strength = document.getElementById('patternStrength').value;
            const timeSec = document.getElementById('patternTime').value;

            // Validate inputs
            if (!selectedFeatures) throw new Error('Please select at least one feature');
            if (interval < 100) throw new Error('Interval must be at least 100ms');
            if (!strength.match(/^\d+(?:;\d+)*$/)) {
                throw new Error('Pattern strength must be semicolon-separated numbers');
            }

            // Build request data
            requestData = {
                command: "Pattern",
                rule: `V:1;F:${selectedFeatures};S:${interval}#`,
                strength: strength,
                timeSec: parseInt(timeSec),
                apiVer: 2
            };

            // Only add toy ID if it's provided
            if (toyId) {
                requestData.toy = toyId;
            }
        }

        const apiUrl = getCurrentApiUrl();
        document.getElementById('patternRequestUrl').innerHTML = `URL: ${apiUrl}`;
        
        // Update request timestamp and display
        patternRequestTime.innerHTML = `Timestamp: ${getChineseTimestamp()}`;
        patternRequest.innerHTML = JSON.stringify(requestData, null, 2);

        const response = await axios.post(apiUrl, requestData, {
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        // Update response timestamp and display
        patternResponseTime.innerHTML = `Timestamp: ${getChineseTimestamp()}`;
        patternResponse.innerHTML = JSON.stringify(response.data, null, 2);
        patternResponse.style.color = '#28a745';
    } catch (error) {
        // Update response timestamp and error display
        patternResponseTime.innerHTML = `Timestamp: ${getChineseTimestamp()}`;
        patternResponse.innerHTML = `Error: ${error.message}`;
        patternResponse.style.color = '#dc3545';
    }
}

function toggleAllFeatures() {
    const checkboxes = document.querySelectorAll('.feature-checkboxes input[type="checkbox"]');
    const button = document.getElementById('toggleFeaturesBtn');
    const isAnyUnchecked = Array.from(checkboxes).some(cb => !cb.checked);
    
    checkboxes.forEach(cb => {
        cb.checked = isAnyUnchecked;
    });
    
    button.textContent = isAnyUnchecked ? 'Uncheck All' : 'Check All';
}

// game mode uses LAN, http 20010 https 30011, request url: http(s)://ip:port/command
function getApiUrl() {
    const localIp = document.getElementById('localIp').value;
    const port = document.getElementById('port').value;
    const useHttps = document.getElementById('useHttps').checked;
    
    if (!localIp || !port) {
        throw new Error('Please enter both IP and Port');
    }

    // Determine protocol and domain based on port and checkbox
    let protocol, domain;
    
    if (port === '20010') {
        protocol = 'http';
        domain = localIp;
    } else if (port === '30010') {
        protocol = 'https';
        domain = `${localIp.replace(/\./g, '-')}.lovense.club`;
    } else {
        protocol = useHttps ? 'https' : 'http';
        domain = protocol === 'https' ? 
            `${localIp.replace(/\./g, '-')}.lovense.club` : 
            localIp;
    }

    return `${protocol}://${domain}:${port}/command`;
}

// Add this helper function to determine the API URL consistently
function getCurrentApiUrl() {
    const isGameMode = document.getElementById('gameSection').style.display !== 'none';
    
    if (isGameMode) {
        return getApiUrl();
    } else {
        // For QR code mode, get URL from callback
        const callbackDataElement = document.getElementById('callbackData');
        const callbackText = callbackDataElement.textContent;
        
        if (callbackText === 'Waiting for data...') {
            throw new Error('No connection data available. Please scan QR code and wait for connection.');
        }

        try {
            const jsonStart = callbackText.indexOf('{');
            if (jsonStart === -1) {
                throw new Error('No valid connection data found. Please scan QR code again.');
            }
            
            const jsonStr = callbackText.substring(jsonStart);
            const data = JSON.parse(jsonStr);
            return `https://${data.domain}:${data.httpsPort}/command`;
        } catch (error) {
            if (error.message.includes('Invalid connection data')) {
                throw error;
            }
            throw new Error('Failed to parse connection data. Please scan QR code again.');
        }
    }
}

function switchPatternV2Tab(tabName) {
    // Update tab buttons
    document.querySelectorAll('.pattern-v2-tabs .pattern-v2-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelector(`.pattern-v2-tab[onclick*="${tabName}"]`).classList.add('active');

    // Update tab content
    document.querySelectorAll('#setup-tab, #play-tab, #sync-tab').forEach(content => {
        content.classList.remove('active');
    });
    document.getElementById(`${tabName}-tab`).classList.add('active');
}

async function testPatternV2() {
    const activeTab = document.querySelector('.pattern-v2-tabs .pattern-v2-tab.active');
    const type = activeTab.getAttribute('onclick').match(/switchPatternV2Tab\('(.+?)'\)/)[1];
    
    const patternv2Request = document.getElementById('patternv2Request');
    const patternv2Response = document.getElementById('patternv2Response');
    const patternv2RequestTime = document.getElementById('patternv2RequestTime');
    const patternv2ResponseTime = document.getElementById('patternv2ResponseTime');
    const toyId = document.getElementById('patternv2ToyId').value;

    try {
        let requestData = {
            command: "PatternV2",
            type: type.charAt(0).toUpperCase() + type.slice(1),
            apiVer: 1
        };

        if (toyId) {
            requestData.toy = toyId;
        }

        // Add type-specific properties
        switch(type) {
            case 'setup':
                const isJsonMode = document.querySelector('input[name="setupInputMethod"]:checked').value === 'json';
                if (isJsonMode) {
                    const jsonInput = document.getElementById('setupJsonInput').value.trim();
                    if (jsonInput) {
                        requestData.actions = JSON.parse(jsonInput);
                    } else {
                        throw new Error('Please enter JSON data');
                    }
                } else {
                    const actionRows = document.querySelectorAll('.action-row');
                    if (actionRows.length === 0) {
                        throw new Error('Please add at least one action');
                    }
                    requestData.actions = Array.from(actionRows).map(row => ({
                        ts: parseInt(row.querySelector('.ts-input').value),
                        pos: parseInt(row.querySelector('.pos-input').value)
                    }));
                }
                break;
            case 'play':
                requestData.startTime = parseInt(document.getElementById('playStartTime').value || 0);
                requestData.offsetTime = parseInt(document.getElementById('playOffsetTime').value || 0);
                requestData.timeMs = parseInt(document.getElementById('playTimeMS').value || 10000);
                break;
            case 'sync':
                // Store t1 in requestData for sync
                requestData.t1 = Date.now();
                document.getElementById('syncT1').textContent = new Date(requestData.t1).toISOString();
                break;
        }

        const apiUrl = getCurrentApiUrl();
        document.getElementById('patternv2RequestUrl').innerHTML = `URL: ${apiUrl}`;
        
        // Update request display
        patternv2RequestTime.innerHTML = `Timestamp: ${getChineseTimestamp()}`;
        patternv2Request.innerHTML = JSON.stringify(requestData, null, 2);

        const response = await axios.post(apiUrl, requestData);
        
        if (type === 'sync') {
            const t2 = Date.now();
            document.getElementById('syncT2').textContent = new Date(t2).toISOString();
            document.getElementById('syncOffset').textContent = `${t2 - requestData.t1}ms`;
        }
        
        // Update response display
        patternv2ResponseTime.innerHTML = `Timestamp: ${getChineseTimestamp()}`;
        patternv2Response.innerHTML = JSON.stringify(response.data, null, 2);
        patternv2Response.style.color = '#28a745';
    } catch (error) {
        patternv2ResponseTime.innerHTML = `Timestamp: ${getChineseTimestamp()}`;
        patternv2Response.innerHTML = `Error: ${error.message}`;
        patternv2Response.style.color = '#dc3545';
    }
}

async function stopFunction() {
    try {
        // Find the active section that contains the clicked stop button
        const activeSection = document.querySelector('.test-section:has(.btn-danger:focus)') || 
                            document.querySelector('.test-section:has(.api-test-results)');
                            
        // Get the elements from the active section
        const requestElement = activeSection.querySelector('[id$="Request"]');
        const responseElement = activeSection.querySelector('[id$="Response"]');
        const requestTimeElement = activeSection.querySelector('[id$="RequestTime"]');
        const responseTimeElement = activeSection.querySelector('[id$="ResponseTime"]');
        const requestUrlElement = activeSection.querySelector('[id$="RequestUrl"]');

        const requestData = {
            command: "Function",
            action: "Stop",
            apiVer: 1
        };
        
        // Get toy ID from the active section if it exists
        const toyIdInput = activeSection.querySelector('input[id$="ToyId"]');
        if (toyIdInput && toyIdInput.value) {
            requestData.toy = toyIdInput.value;
        }

        const apiUrl = getCurrentApiUrl();
        if (requestUrlElement) {
            requestUrlElement.innerHTML = `URL: ${apiUrl}`;
        }
        
        // Update request display
        if (requestTimeElement) {
            requestTimeElement.innerHTML = `Timestamp: ${getChineseTimestamp()}`;
        }
        if (requestElement) {
            requestElement.innerHTML = JSON.stringify(requestData, null, 2);
        }

        const response = await axios.post(apiUrl, requestData);
        
        // Update response display
        if (responseTimeElement) {
            responseTimeElement.innerHTML = `Timestamp: ${getChineseTimestamp()}`;
        }
        if (responseElement) {
            responseElement.innerHTML = JSON.stringify(response.data, null, 2);
            responseElement.style.color = '#28a745';
        }
    } catch (error) {
        const activeSection = document.querySelector('.test-section:has(.btn-danger:focus)') ||
                            document.querySelector('.test-section:has(.api-test-results)');
        const responseElement = activeSection.querySelector('[id$="Response"]');
        const responseTimeElement = activeSection.querySelector('[id$="ResponseTime"]');
        
        if (responseTimeElement) {
            responseTimeElement.innerHTML = `Timestamp: ${getChineseTimestamp()}`;
        }
        if (responseElement) {
            responseElement.innerHTML = `Error: ${error.message}`;
            responseElement.style.color = '#dc3545';
        }
        console.error('Stop function error:', error);
    }
}

function formatJsonInput() {
    const textarea = document.getElementById('patternJson');
    try {
        const jsonObj = JSON.parse(textarea.value.trim() || textarea.placeholder);
        textarea.value = JSON.stringify(jsonObj, null, 4);
        
        // Adjust textarea height to fit content
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';
    } catch (e) {
        alert('Invalid JSON: ' + e.message);
    }
}

// Replace copyToJson with copyFormToJson
function copyPatternV2FormToJson() {
    const actionsContainer = document.getElementById('patternActions');
    const rows = actionsContainer.querySelectorAll('.action-row');
    
    // Convert form inputs to JSON format
    const actions = Array.from(rows).map(row => {
        const timestamp = parseInt(row.querySelector('.ts-input').value) || 0;
        const position = parseInt(row.querySelector('.pos-input').value) || 0;
        return {
            ts: timestamp,
            pos: position
        };
    });

    // Format JSON with proper indentation
    const formattedJson = JSON.stringify(actions, null, 4);

    // Create a temporary textarea to handle the copy
    const tempTextArea = document.createElement('textarea');
    tempTextArea.value = formattedJson;
    document.body.appendChild(tempTextArea);
    
    // Select and copy the text
    tempTextArea.select();
    document.execCommand('copy');
    
    // Remove the temporary textarea
    document.body.removeChild(tempTextArea);

    // Show feedback to user
    const copyButton = document.querySelector('button[onclick="copyPatternV2FormToJson()"]');
    const originalText = copyButton.textContent;
    copyButton.textContent = 'Copied!';
    setTimeout(() => {
        copyButton.textContent = originalText;
    }, 2000);

    // Also update the JSON input if it exists
    const jsonInput = document.getElementById('setupJsonInput');
    if (jsonInput) {
        jsonInput.value = formattedJson;
    }
}

// Update addPatternAction to only have + and × buttons
function addPatternAction() {
    const actionsContainer = document.getElementById('patternActions');
    const rows = actionsContainer.querySelectorAll('.action-row');
    const lastRow = rows[rows.length - 1];
    
    let lastTs = 0;
    let lastPos = 50;
    if (lastRow) {
        lastTs = parseInt(lastRow.querySelector('.ts-input').value) || 0;
        lastPos = parseInt(lastRow.querySelector('.pos-input').value) || 50;
    }
    
    // Calculate new position with minimum 20 difference
    let newPos;
    do {
        newPos = Math.floor(Math.random() * 101); // 0-100
    } while (Math.abs(newPos - lastPos) < 20);
    
    const newRow = document.createElement('div');
    newRow.className = 'action-row';
    newRow.innerHTML = `
        <div class="input-group">
            <label>Timestamp (ms):</label>
            <input type="number" class="form-control ts-input" min="0" max="7200000" value="${lastTs + 100}">
        </div>
        <div class="input-group">
            <label>Position (0-100):</label>
            <input type="number" class="form-control pos-input" min="0" max="100" value="${newPos}">
        </div>
        <div class="action-buttons">
            <button onclick="removePatternAction(this)" class="btn btn-icon btn-danger">×</button>
            <button onclick="addPatternAction()" class="btn btn-icon btn-secondary">+</button>
        </div>
    `;
    actionsContainer.appendChild(newRow);
}

function removePatternAction(button) {
    const actionRows = document.querySelectorAll('.action-row');
    if (actionRows.length > 1) {
        button.closest('.action-row').remove();
    } else {
        alert('Cannot remove the last action row');
    }
}

function clearPatternActions() {
    const actionsContainer = document.getElementById('patternActions');
    actionsContainer.innerHTML = '';
    addPatternAction(); // Add one empty row
}

// Add this to format JSON for both Pattern and PatternV2
function formatPatternV2Json() {
    const textarea = document.getElementById('setupJsonInput');
    try {
        const jsonObj = JSON.parse(textarea.value.trim() || textarea.placeholder);
        textarea.value = JSON.stringify(jsonObj, null, 4);
        
        // Adjust textarea height to fit content
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';
    } catch (e) {
        alert('Invalid JSON: ' + e.message);
    }
}

// Update the DOMContentLoaded event listener
document.addEventListener('DOMContentLoaded', () => {
    // Initialize Pattern tabs
    switchPatternTab('form');
    
    // Initialize PatternV2 tabs
    switchPatternV2Tab('setup');
    
    // Setup JSON textarea auto-resize for Pattern
    const jsonTextarea = document.getElementById('patternJson');
    if (jsonTextarea) {
        jsonTextarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
        });
        
        jsonTextarea.addEventListener('focus', function() {
            if (!this.value) {
                this.value = JSON.stringify(JSON.parse(this.placeholder), null, 4);
                this.style.height = 'auto';
                this.style.height = this.scrollHeight + 'px';
            }
        });
    }
    
    // Setup JSON textarea auto-resize for PatternV2
    const setupJsonInput = document.getElementById('setupJsonInput');
    if (setupJsonInput) {
        setupJsonInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
        });
        
        setupJsonInput.addEventListener('focus', function() {
            if (!this.value) {
                this.value = JSON.stringify(JSON.parse(this.placeholder), null, 4);
                this.style.height = 'auto';
                this.style.height = this.scrollHeight + 'px';
            }
        });
    }
});

function switchPatternTab(tabName) {
    // Update tab buttons
    document.querySelectorAll('.pattern-tabs .pattern-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelector(`.pattern-tab[onclick*="${tabName}"]`).classList.add('active');

    // Update tab content
    document.querySelectorAll('#formInputTab, #jsonInputTab').forEach(content => {
        content.classList.remove('active');
    });
    document.getElementById(`${tabName}InputTab`).classList.add('active');
}

function resetAllActions() {
    // Reset all sliders and number inputs
    const sliders = document.querySelectorAll('.strength-slider');
    const numbers = document.querySelectorAll('.strength-number');
    
    sliders.forEach(slider => {
        slider.value = 0;
    });
    
    numbers.forEach(number => {
        number.value = 0;
    });
}

async function testPresetPattern() {
    const presetRequest = document.getElementById('presetRequest');
    const presetResponse = document.getElementById('presetResponse');
    const presetRequestTime = document.getElementById('presetRequestTime');
    const presetResponseTime = document.getElementById('presetResponseTime');
    
    try {
        const toyId = document.getElementById('presetToyId').value;
        const name = document.querySelector('input[name="presetPattern"]:checked').value;
        const timeSec = parseFloat(document.getElementById('presetTime').value) || 0;

        const requestData = {
            command: "Preset",
            name: name,
            timeSec: timeSec,
            apiVer: 1
        };

        if (toyId) {
            requestData.toy = toyId;
        }

        const apiUrl = getCurrentApiUrl();
        document.getElementById('presetRequestUrl').innerHTML = `URL: ${apiUrl}`;
        
        // Update request display
        presetRequestTime.innerHTML = `Timestamp: ${getChineseTimestamp()}`;
        presetRequest.innerHTML = JSON.stringify(requestData, null, 2);

        const response = await axios.post(apiUrl, requestData);
        
        // Update response display
        presetResponseTime.innerHTML = `Timestamp: ${getChineseTimestamp()}`;
        presetResponse.innerHTML = JSON.stringify(response.data, null, 2);
        presetResponse.style.color = '#28a745';
    } catch (error) {
        presetResponseTime.innerHTML = `Timestamp: ${getChineseTimestamp()}`;
        presetResponse.innerHTML = `Error: ${error.message}`;
        presetResponse.style.color = '#dc3545';
    }
}

function setupInputMethodChange() {
    const isJsonMode = document.querySelector('input[name="setupInputMethod"]:checked').value === 'json';
    document.getElementById('setupFormSection').style.display = isJsonMode ? 'none' : 'block';
    document.getElementById('setupJsonSection').style.display = isJsonMode ? 'block' : 'none';
}

// Add event listener
document.addEventListener('DOMContentLoaded', () => {
    // ... existing code ...
    
    // Add change event listener for setup input method
    const setupInputMethodRadios = document.querySelectorAll('input[name="setupInputMethod"]');
    setupInputMethodRadios.forEach(radio => {
        radio.addEventListener('change', setupInputMethodChange);
    });
});
</script>

<style>
.api-documentation {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
}

h1 {
    color: #2c3e50;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #eee;
}

.test-section {
    background: #fff;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

h3 {
    color: #34495e;
    margin-bottom: 1rem;
    font-size: 1.2rem;
}

.form-control {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    margin-bottom: 1rem;
    font-size: 1rem;
}

.btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 500;
    transition: all 0.2s;
    margin-right: 0.5rem;
    margin-bottom: 0.5rem;
}

.btn-primary {
    background: #3498db;
    color: white;
}

.btn-primary:hover {
    background: #2980b9;
}

.btn-secondary {
    background: #95a5a6;
    color: white;
}

.btn-danger {
    background: #e74c3c;
    color: white;
}

.data-box {
    background: #f8f9fa;
    border: 1px solid #eee;
    border-radius: 4px;
    padding: 1rem;
    margin-top: 1rem;
    font-family: monospace;
    white-space: pre-wrap;
}

.qr-container {
    display: flex;
    justify-content: center;
    padding: 1rem;
    background: #fff;
    border-radius: 4px;
}

.connection-methods {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.btn-method {
    padding: 0.75rem 1.5rem;
    font-size: 0.9rem;
    background: #3498db;
    color: white;
}

.btn-method:hover {
    background: #2980b9;
}

.game-mode-inputs {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.input-port-group {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
}

.input-port-group .form-control {
    flex: 1;
    margin: 0;
}

.function-test-container {
    padding: 20px;
}

.button-container {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 20px;
}

.toy-id-group {
    display: flex;
    align-items: center;
    gap: 10px;
    flex: 1;
}

.toy-id-group label {
    min-width: 60px;
    font-size: 0.9em;
    color: #666;
    font-weight: 500;
}

.toy-id-group .form-control {
    max-width: 200px;
}

.game-setup p {
    margin: 0.5rem 0;
    color: #666;
}

@media (prefers-color-scheme: dark) {
    .game-setup p {
        color: #aaa;
    }
}

/* Update action group styles for inline layout */
.action-group {
    display: flex;
    align-items: center;
    padding: 8px 12px;
    background: #f8f9fa;
    border-radius: 4px;
    margin-bottom: 8px;
}

.action-group label {
    min-width: 140px;
    font-size: 0.9em;
    margin-right: 10px;
    color: #666;
}

.strength-control {
    display: flex;
    align-items: center;
    flex: 1;
    gap: 10px;
}

.strength-slider {
    flex: 1;
    margin: 0;
}

.strength-number {
    width: 60px !important;
    padding: 4px 8px !important;
    margin: 0 !important;
}

/* Update time inputs for inline layout */
.time-inputs {
    display: flex;
    align-items: center;
    gap: 20px;
    background: #f8f9fa;
    padding: 12px;
    border-radius: 4px;
    margin: 15px 0;
}

.time-inputs .input-group {
    display: flex;
    align-items: center;
    flex: 1;
    gap: 10px;
    margin: 0;
}

.time-inputs .input-group label {
    min-width: 100px;
    white-space: nowrap;
    margin: 0;
}

.time-inputs .form-control {
    margin: 0;
}

/* Dark mode support */
@media (prefers-color-scheme: dark) {
    .action-group {
        background: #2d2d2d;
    }
    
    .action-group label {
        color: #aaa;
    }
    
    .time-inputs {
        background: #2d2d2d;
    }
}

.token-input-group {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 1rem;
}

.token-input-group .form-control {
    margin-bottom: 0;
}

.token-input-group .btn {
    margin: 0;
    white-space: nowrap;
}

.request-json {
    margin: 1rem 0;
}

.request-json p {
    margin-bottom: 0.5rem;
    color: #666;
    font-weight: 500;
}

@media (prefers-color-scheme: dark) {
    .request-json p {
        color: #aaa;
    }
}

/* Reduce spacing between elements */
.qr-container.compact {
    padding: 0.5rem;
    margin: 0.5rem 0;
}

.info-text {
    margin: 0.25rem 0;
    color: #666;
}

.game-mode-inputs {
    margin: 0.5rem 0;
}

.request-json.compact {
    margin: 0.5rem 0;
}

.request-json.compact p {
    margin-bottom: 0.25rem;
}

.data-box {
    margin-top: 0.5rem;
}

/* Dark mode support */
@media (prefers-color-scheme: dark) {
    .info-text {
        color: #aaa;
    }
}

/* API Reference styling */
.api-reference {
    background: #f8f9fa;
    border-left: 4px solid #3498db;
    padding: 1rem;
    margin-bottom: 2rem;
    border-radius: 0 4px 4px 0;
}

.api-reference p {
    margin: 0;
    font-size: 0.95rem;
    color: #2c3e50;
}

.api-reference a {
    color: #3498db;
    text-decoration: none;
    font-weight: 500;
}

.api-reference a:hover {
    text-decoration: underline;
}

/* Dark mode support */
@media (prefers-color-scheme: dark) {
    .api-reference {
        background: #2d2d2d;
        border-left-color: #3498db;
    }

    .api-reference p {
        color: #fff;
    }

    .api-reference a {
        color: #5dade2;
    }
}

.request-url {
    font-family: monospace;
    color: #0066cc;
    margin-bottom: 8px;
    padding: 4px 0;
    font-size: 0.9em;
}

.timestamp {
    font-family: monospace;
    color: #666;
    font-size: 0.85em;
    margin-bottom: 8px;
}

/* Dark mode support */
@media (prefers-color-scheme: dark) {
    .timestamp {
        color: #aaa;
    }
}

.connection-container {
    margin-top: 1rem;
}

.connection-methods {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.btn-sm {
    padding: 0.4rem 1rem;
    font-size: 0.9rem;
}

.btn-method {
    width: auto;
    min-width: 120px;
}

.connection-section {
    border-top: 1px solid #eee;
    padding-top: 1rem;
    margin-top: 0.5rem;
}

/* Dark mode support */
@media (prefers-color-scheme: dark) {
    .connection-section {
        border-top-color: #404040;
    }
}

.pattern-test-container {
    padding: 20px;
}

.pattern-inputs {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-bottom: 20px;
}

.feature-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.feature-checkboxes {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
}

.feature-checkboxes label {
    display: flex;
    align-items: center;
    gap: 5px;
    cursor: pointer;
}

.feature-checkboxes input[type="checkbox"] {
    margin: 0;
}

.pattern-group, .interval-group, .time-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

/* Dark mode support */
@media (prefers-color-scheme: dark) {
    .feature-checkboxes label {
        color: #fff;
    }
}

.input-method-toggle {
    margin-bottom: 1rem;
    display: flex;
    gap: 0.5rem;
}

.json-input-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.json-textarea {
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace;
    font-size: 0.9rem;
    line-height: 1.4;
    padding: 1rem;
    min-height: auto;
    height: auto;
    resize: none;
    white-space: pre;
    tab-size: 2;
    background: #f8f9fa;
    border: 1px solid #ddd;
}

.json-textarea:focus {
    background: #fff;
}

/* Dark mode support */
@media (prefers-color-scheme: dark) {
    .pattern-tabs {
        border-bottom-color: #404040;
    }

    .json-textarea {
        background: #2d2d2d;
        border-color: #404040;
        color: #e0e0e0;
    }

    .json-textarea:focus {
        background: #1a1a1a;
    }
}

.pattern-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #eee;
}

.pattern-tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    border-bottom: 1px solid #ddd;
    padding-bottom: 0.5rem;
}

.pattern-tab {
    padding: 0.5rem 1rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    background: #f8f9fa;
    cursor: pointer;
    font-size: 0.85rem;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.pattern-tab.active {
    background: #3498db;
    color: white;
    border-color: #3498db;
}

.pattern-tab-content {
    display: none;
    padding: 1.5rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    margin-bottom: 1.5rem;
}

.pattern-tab-content.active {
    display: block;
}

.pattern-timing {
    display: flex;
    gap: 1.5rem;
    margin-top: 1rem;
}

.interval-group,
.time-group {
    flex: 1;
}

.json-editor {
    position: relative;
}

.json-hint {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0.5rem;
    color: #666;
    font-size: 0.9rem;
}

.hint-icon {
    font-style: normal;
}

/* Dark mode support */
@media (prefers-color-scheme: dark) {
    .pattern-header {
        border-bottom-color: #404040;
    }

    .pattern-tab {
        background: #2d2d2d;
        border-color: #404040;
        color: #fff;
    }

    .pattern-tab.active {
        background: #3498db;
        border-color: #3498db;
    }

    .pattern-tab-content {
        border-color: #404040;
        background: #1a1a1a;
    }

    .json-hint {
        color: #aaa;
    }
}

/* PatternV2 Styles */
.patternv2-container {
    padding: 20px;
}

.patternv2-tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
    border-bottom: 1px solid #ddd;
    padding-bottom: 8px;
}

.tab-btn {
    padding: 8px 16px;
    border: 1px solid #ddd;
    border-radius: 4px;
    background: #f8f9fa;
    cursor: pointer;
    transition: all 0.2s;
}

.tab-btn.active {
    background: #3498db;
    color: white;
    border-color: #3498db;
}

.tab-content {
    display: none;
    padding: 20px;
    border: 1px solid #ddd;
    border-radius: 4px;
    margin-bottom: 20px;
}

.tab-content.active {
    display: block;
}

.action-row {
    display: flex;
    align-items: center;
    gap: 10px;
    background: white;
    padding: 10px;
    border-radius: 4px;
    border: 1px solid #dee2e6;
}

.action-row .input-group {
    display: flex;
    align-items: center;
    gap: 10px;
    flex: 1;
}

.action-row .input-group label {
    min-width: 120px;
    font-size: 0.9em;
    color: #666;
}

.action-row .form-control {
    width: 100px;
}

.action-buttons {
    margin-top: 12px;
}

.json-section {
    margin-top: 20px;
}

.json-textarea {
    width: 100%;
    min-height: 100px;
    font-family: monospace;
    padding: 8px;
    margin-bottom: 8px;
}

.hint {
    font-size: 0.9em;
    color: #666;
    margin-bottom: 12px;
}

.sync-info {
    margin-bottom: 20px;
}

.sync-results {
    background: #f8f9fa;
    padding: 12px;
    border-radius: 4px;
    margin-top: 12px;
}

/* Dark mode support */
@media (prefers-color-scheme: dark) {
    .tab-btn {
        background: #2d2d2d;
        border-color: #404040;
        color: #fff;
    }
    
    .tab-btn.active {
        background: #3498db;
        border-color: #3498db;
    }
    
    .tab-content {
        border-color: #404040;
        background: #1a1a1a;
    }
    
    .hint {
        color: #aaa;
    }
    
    .sync-results {
        background: #2d2d2d;
    }
}

/* Add these styles to your existing CSS */
.qr-setup .api-test-results {
    margin-top: 20px;
    margin-bottom: 20px;
    border-top: 1px solid #eee;
    border-bottom: 1px solid #eee;
    padding: 20px 0;
}

.qr-setup .request-box,
.qr-setup .response-box {
    margin-bottom: 15px;
}

.qr-setup h4 {
    color: #666;
    margin-bottom: 10px;
    font-size: 1rem;
}

.qr-setup .data-box {
    background: #f8f9fa;
    border: 1px solid #eee;
    border-radius: 4px;
    padding: 10px;
    font-family: monospace;
    font-size: 0.9em;
    margin-top: 5px;
}

/* Dark mode support */
@media (prefers-color-scheme: dark) {
    .qr-setup h4 {
        color: #aaa;
    }
    
    .qr-setup .data-box {
        background: #2d2d2d;
        border-color: #404040;
    }
    
    .qr-setup .api-test-results {
        border-color: #404040;
    }
}

.pattern-tabs,
.pattern-v2-tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    border-bottom: 1px solid #ddd;
    padding-bottom: 0.5rem;
}

.pattern-tab,
.pattern-v2-tab {
    padding: 0.5rem 1rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    background: #f8f9fa;
    cursor: pointer;
    font-size: 0.85rem;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.pattern-tab.active,
.pattern-v2-tab.active {
    background: #3498db;
    color: white;
    border-color: #3498db;
}

.pattern-tab-content {
    display: none;
    padding: 1.5rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    margin-bottom: 1.5rem;
}

.pattern-tab-content.active {
    display: block;
}

.pattern-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #eee;
}

.pattern-header .toy-id-group {
    display: flex;
    align-items: center;
    gap: 10px;
    white-space: nowrap;
}

.pattern-header .toy-id-group .form-control {
    width: 200px;
    margin: 0;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.section-header h4 {
    margin: 0;
}

.action-row {
    display: flex;
    align-items: center;
    gap: 10px;
    background: white;
    padding: 10px;
    border-radius: 4px;
    border: 1px solid #dee2e6;
    margin-bottom: 8px;
}

.action-row .input-group {
    display: flex;
    align-items: center;
    gap: 10px;
}

.action-row .input-group label {
    min-width: 120px;
    font-size: 0.9em;
    color: #666;
    white-space: nowrap;
}

.action-row .input-group .form-control {
    width: 120px;
    margin: 0;
}

.action-buttons {
    display: flex;
    gap: 4px;
}

.btn-icon {
    padding: 4px 8px;
    min-width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    margin: 0;
}

.btn-sm {
    padding: 0.25rem 0.75rem;
    font-size: 0.85rem;
}

.json-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.json-textarea {
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace;
    font-size: 0.9rem;
    line-height: 1.4;
    padding: 1rem;
    min-height: auto;
    height: auto;
    resize: none;
    white-space: pre;
    tab-size: 2;
    background: #f8f9fa;
    border: 1px solid #ddd;
}

.json-textarea.compact {
    height: 80px;
    max-width: 600px;
}

.json-textarea:focus {
    background: #fff;
}

.input-group.compact {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 1rem;
}

.input-group.compact label {
    min-width: 160px;
    white-space: nowrap;
}

.input-group.compact .form-control {
    width: 160px;
    margin: 0;
}

.sync-info {
    margin-bottom: 20px;
}

.sync-results {
    background: #f8f9fa;
    padding: 12px;
    border-radius: 4px;
    margin-top: 12px;
}

/* Dark mode support */
@media (prefers-color-scheme: dark) {
    .pattern-tabs,
    .pattern-v2-tabs {
        border-bottom-color: #404040;
    }
    
    .pattern-tab,
    .pattern-v2-tab {
        background: #2d2d2d;
        border-color: #404040;
        color: #fff;
    }
    
    .pattern-tab.active,
    .pattern-v2-tab.active {
        background: #3498db;
        border-color: #3498db;
    }
    
    .action-row {
        background: #2d2d2d;
        border-color: #404040;
    }
    
    .action-row .input-group label {
        color: #aaa;
    }
    
    .json-textarea {
        background: #2d2d2d;
        border-color: #404040;
        color: #e0e0e0;
    }
    
    .json-textarea:focus {
        background: #1a1a1a;
    }
    
    .sync-results {
        background: #2d2d2d;
    }
}

.preset-inputs {
    margin-bottom: 1.5rem;
    max-width: 600px;
}

.preset-inputs select.form-control {
    width: 160px;
    margin: 0;
}

.preset-options {
    display: flex;
    gap: 1.5rem;
}

.preset-option {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
}

.preset-option input[type="radio"] {
    margin: 0;
}

.section-controls {
    display: flex;
    gap: 0.5rem;
}

.btn-info {
    background-color: #17a2b8;
    border-color: #17a2b8;
    color: white;
}

.btn-info:hover {
    background-color: #138496;
    border-color: #117a8b;
}

.input-method-toggle {
    display: flex;
    gap: 2rem;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #ddd;
}

.input-method-option {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
}

.input-method-option input[type="radio"] {
    margin: 0;
}

/* Dark mode support */
@media (prefers-color-scheme: dark) {
    .input-method-toggle {
        border-bottom-color: #404040;
    }
}
</style> 